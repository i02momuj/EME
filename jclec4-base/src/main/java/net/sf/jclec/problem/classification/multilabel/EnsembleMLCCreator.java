package net.sf.jclec.problem.classification.multilabel;

import net.sf.jclec.binarray.BinArrayCreator;
import java.util.HashSet;

public class EnsembleMLCCreator extends BinArrayCreator
{
	/////////////////////////////////////////////////////////////////
	// --------------------------------------- Serialization constant
	/////////////////////////////////////////////////////////////////
	
	/** Generated by Eclipse */
	
	private static final long serialVersionUID = -2638928425169895614L;
	
	/////////////////////////////////////////////////////////////////
	// --------------------------------------------------- Properties
	/////////////////////////////////////////////////////////////////
	
	private int numberLabels;
	
	private int numberClassifiers;
	
	private int maxNumberLabelsClassifier;
	
	private boolean variable;

	/////////////////////////////////////////////////////////////////
	// ------------------------------------------------- Constructors
	/////////////////////////////////////////////////////////////////
	
	public EnsembleMLCCreator() 
	{
		super();
	}

	/////////////////////////////////////////////////////////////////
	// -------------------------------------------- Protected methods
	/////////////////////////////////////////////////////////////////
	
	/**
	 * {@inheritDoc}
	 */
	
	@Override
	protected void createNext() 
	{
		createdBuffer.add(species.createIndividual(createGenotype()));
	}
	
	/////////////////////////////////////////////////////////////////
	// ----------------------------------------------- Public methods
	/////////////////////////////////////////////////////////////////
	
	public void setNumberLabels(int numberLabels) {
		this.numberLabels = numberLabels;
	}

	public void setNumberClassifiers(int numberClassifiers) {
		this.numberClassifiers = numberClassifiers;
	}

	public void setMaxNumberLabelsClassifier(int maxNumberLabelsClassifier) {
		this.maxNumberLabelsClassifier = maxNumberLabelsClassifier;
	}

	public void setVariable(boolean variable)
	{
		this.variable=variable;
	}
	
	/////////////////////////////////////////////////////////////////
	// ---------------------------------------------- Private methods
	/////////////////////////////////////////////////////////////////
	
	/**
	 * Create a int [] genotype
	 */
	
	private final byte [] createGenotype()
	{
		byte [] result = new byte[numberClassifiers * numberLabels];
		HashSet<String> Combinations = new HashSet<String>();
		
		//For each classifier in the ensemble		
		for (int model=0; model<numberClassifiers; )
		{			
			int numLabelsClassifer;
			if (variable)
				numLabelsClassifer = randgen.choose(2, maxNumberLabelsClassifier+1); //At least 2 labels
			else
				numLabelsClassifer = maxNumberLabelsClassifier;	
			
			//Inicializations
			StringBuffer comb2 = new StringBuffer("");			
			boolean visited[] = new boolean[numberLabels];	
			
			for(int label=0; label<numberLabels; label++)
			{	   
			   visited[label]=false;
			   result[model*numberLabels+label]=0;
			   comb2.append('0');
			}
			   
			for(int label=0; label<numLabelsClassifer; ) 
			{
	           //Random selection of one label		
	           int randomLabel= (int) randgen.choose(0, numberLabels);
	           if(!visited[randomLabel])
	           {	   
				  visited[randomLabel]=true;
				  result[model*numberLabels+randomLabel]=1;
				  comb2.setCharAt(randomLabel, '1');
	          	  label++;
	           }   
			}	
			
			if((checkModel(model, result)==true) && (Combinations.add(comb2.toString())==true))
			{   //Checks if the model is already in the ensemble
	             model++;
			}
		}	
		
		return result;
	}	
	
	protected boolean checkModel(int model, byte genotype[])
	{
		boolean check = true;
		
		//Check if the model is 0, maxInteger-1 (all 1s), pow of 2 (0 or 1 labels selected)
        int count0s=0, count1s=0;
        for(int label=0; label< numberLabels; label++)
        {
        	if(genotype[model*numberLabels+label]==0)
        		count0s+=1;
        	if(genotype[model*numberLabels+label]==1)
        		count1s+=1;        	
        }
        if ((count0s==numberLabels)||(count1s==numberLabels)||(count1s==1))
        	check=false;
        
        return(check);	
	}
}